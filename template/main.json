{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.3.255.40792",
      "templateHash": "4402575046167796421"
    }
  },
  "functions": [],
  "variables": {
    "targetSubscriptionId": "[subscription()]",
    "namePrefix": "quotamgr3",
    "location": "[resourceGroup().location]",
    "quota": 100,
    "FSstorageAccountName": "[format('fs{0}{1}', variables('namePrefix'), uniqueString(resourceGroup().id))]",
    "QUstorageAccountName": "[format('qu{0}{1}', variables('namePrefix'), uniqueString(resourceGroup().id))]",
    "storageAccountName": "[format('ap{0}{1}', variables('namePrefix'), uniqueString(resourceGroup().id))]",
    "hostingPlanName": "[format('apphp{0}{1}', variables('namePrefix'), uniqueString(resourceGroup().id))]",
    "appInsightsName": "[format('appin{0}{1}', variables('namePrefix'), uniqueString(resourceGroup().id))]",
    "functionAppName": "[format('app{0}', variables('namePrefix'))]",
    "fileShareName": "testshare1",
    "sasUri": "https://ququotamgr3cm5dzmnn2isvk.blob.core.windows.net/sharestats/filesharestats.log?sp=r&st=2022-01-14T03:54:19Z&se=3022-01-14T11:54:19Z&spr=https&sv=2020-08-04&sr=b&sig=qrI9VQ8VQi7ZPcB%2F0vOgikIHtuVE%2Bo5byED1hFXMLTw%3D",
    "workbookData": "{ \"version\": \"Notebook/1.0\", \r\n      \"items\": [\r\n        {\r\n          \"type\": 1,\r\n          \"content\": {\r\n            \"json\": \"## Azure Premium File Shares\\r\\n---\"\r\n          },\r\n          \"name\": \"text - 0\"\r\n        },\r\n        {\r\n          \"type\": 3,\r\n          \"content\": {\r\n            \"version\": \"KqlItem/1.0\",\r\n            \"query\": \"let PFSstats = (externaldata (Resource:string, ShareStatsCollection:dynamic ) [@\\\"https://ququotamgr3cm5dzmnn2isvk.blob.core.windows.net/sharestats/filesharestats.log?sp=r&st=2022-01-14T03:54:19Z&se=3022-01-14T11:54:19Z&spr=https&sv=2020-08-04&sr=b&sig=qrI9VQ8VQi7ZPcB%2F0vOgikIHtuVE%2Bo5byED1hFXMLTw%3D\\\"] with(format=\\\"multijson\\\"));\\r\\n\\r\\nPFSstats\\r\\n| mv-expand ShareStatsCollection\\r\\n| extend FileShare = parse_json(ShareStatsCollection).FileShare, StorageAccount = parse_json(ShareStatsCollection).StorageAccount, SubscriptionId = parse_json(ShareStatsCollection).SubscriptionId, ResourceGroup = parse_json(ShareStatsCollection).ResourceGroup, Quota = parse_json(ShareStatsCollection).ProvisionedCapacity, UsedCapacity = parse_json(ShareStatsCollection).UsedCapacity, Autogrow = parse_json(ShareStatsCollection).TagAutogrow, AutogrowWatermark = parse_json(ShareStatsCollection).TagWatermark, AutogrowPercent = parse_json(ShareStatsCollection).quotagrowth\\r\\n| project FileShare, StorageAccount, SubscriptionId, ResourceGroup, Quota, UsedCapacity, Autogrow, AutogrowWatermark, AutogrowPercent\\r\\n| sort by tostring(FileShare) asc\\r\\n\",\r\n            \"size\": 0,\r\n            \"timeContext\": {\r\n              \"durationMs\": 86400000\r\n            },\r\n            \"queryType\": 0,\r\n            \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n            \"crossComponentResources\": [\r\n              \"/subscriptions/32e58a75-e6e2-4539-93ae-27b1ee3bb81b/resourcegroups/defaultresourcegroup-wus2/providers/microsoft.operationalinsights/workspaces/defaultworkspace-32e58a75-e6e2-4539-93ae-27b1ee3bb81b-wus2\"\r\n            ],\r\n            \"gridSettings\": {\r\n              \"labelSettings\": [\r\n                {\r\n                  \"columnId\": \"FileShare\",\r\n                  \"label\": \"Fileshare\"\r\n                },\r\n                {\r\n                  \"columnId\": \"StorageAccount\",\r\n                  \"label\": \"Storage Account\"\r\n                },\r\n                {\r\n                  \"columnId\": \"SubscriptionId\",\r\n                  \"label\": \"Subscription Id\"\r\n                },\r\n                {\r\n                  \"columnId\": \"ResourceGroup\",\r\n                  \"label\": \"Resource Group\"\r\n                },\r\n                {\r\n                  \"columnId\": \"Quota\",\r\n                  \"label\": \"Assigned Quota (GB)\"\r\n                },\r\n                {\r\n                  \"columnId\": \"UsedCapacity\",\r\n                  \"label\": \"Used Capacity (GB)\"\r\n                },\r\n                {\r\n                  \"columnId\": \"Autogrow\",\r\n                  \"label\": \"Autogrow Enabled\"\r\n                },\r\n                {\r\n                  \"columnId\": \"AutogrowWatermark\",\r\n                  \"label\": \"Autogrow Used Watermark (%)\"\r\n                },\r\n                {\r\n                  \"columnId\": \"AutogrowPercent\",\r\n                  \"label\": \"Autogrow %\"\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          \"name\": \"query - 1\",\r\n          \"styleSettings\": {\r\n            \"showBorder\": true\r\n          }\r\n        }\r\n      ],\r\n      \"isLocked\": false,\r\n      \"fallbackResourceIds\": [\r\n        \"azure monitor\"\r\n      ]\r\n    }"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
      "apiVersion": "2021-06-01",
      "name": "[format('{0}/{1}/{2}', variables('QUstorageAccountName'), 'default', 'expandfsquota')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/queueServices', variables('QUstorageAccountName'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('QUstorageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-06-01",
      "name": "[format('{0}/{1}/{2}', variables('QUstorageAccountName'), 'default', 'sharestats')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('QUstorageAccountName'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('QUstorageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/queueServices",
      "apiVersion": "2021-06-01",
      "name": "[format('{0}/{1}', variables('QUstorageAccountName'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('QUstorageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2021-06-01",
      "name": "[format('{0}/{1}', variables('QUstorageAccountName'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('QUstorageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2021-02-01",
      "name": "[format('{0}/{1}', variables('functionAppName'), 'web')]",
      "properties": {
        "powerShellVersion": "~7"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-06-01",
      "name": "[variables('FSstorageAccountName')]",
      "location": "[variables('location')]",
      "kind": "FileStorage",
      "sku": {
        "name": "Premium_LRS"
      },
      "tags": {
        "autogrow": "true",
        "watermark": "85",
        "quotagrowth": "15"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2021-06-01",
      "name": "[format('{0}/default/{1}', variables('FSstorageAccountName'), variables('fileShareName'))]",
      "properties": {
        "enabledProtocols": "SMB",
        "shareQuota": "[variables('quota')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('FSstorageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-06-01",
      "name": "[variables('QUstorageAccountName')]",
      "location": "[variables('location')]",
      "kind": "StorageV2",
      "sku": {
        "name": "Standard_LRS"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-06-01",
      "name": "[variables('storageAccountName')]",
      "location": "[variables('location')]",
      "kind": "StorageV2",
      "sku": {
        "name": "Standard_LRS"
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02-preview",
      "name": "[variables('appInsightsName')]",
      "location": "[variables('location')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "publicNetworkAccessForIngestion": "Enabled",
        "publicNetworkAccessForQuery": "Enabled"
      },
      "tags": {
        "[format('hidden-link:/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Web/sites/{2}', subscription().id, resourceGroup().name, variables('functionAppName'))]": "Resource"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2021-02-01",
      "name": "[variables('hostingPlanName')]",
      "location": "[variables('location')]",
      "sku": {
        "name": "Y1",
        "tier": "Dynamic"
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2020-06-01",
      "name": "[variables('functionAppName')]",
      "location": "[variables('location')]",
      "kind": "functionapp",
      "properties": {
        "httpsOnly": true,
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "clientAffinityEnabled": true,
        "siteConfig": {
          "appSettings": [
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName'))).InstrumentationKey]"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-06-01').keys[0].value)]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "powershell"
            },
            {
              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-06-01').keys[0].value)]"
            },
            {
              "name": "targetSubscriptionId",
              "value": "[variables('targetSubscriptionId').subscriptionId]"
            },
            {
              "name": "tag_autogrow",
              "value": "autogrow"
            },
            {
              "name": "tag_quotagrowth",
              "value": "quotagrowth"
            },
            {
              "name": "tag_watermark",
              "value": "watermark"
            },
            {
              "name": "outputMessageQueue_STORAGE",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('QUstorageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('QUstorageAccountName')), '2021-06-01').keys[0].value)]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('QUstorageAccountName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2021-08-01",
      "name": "[guid('shareStats')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "env": "Dev"
      },
      "kind": "user",
      "properties": {
        "category": "workbook",
        "description": "Share usage statistics",
        "displayName": "Share Stats Dev",
        "serializedData": "[variables('workbookData')]",
        "sourceId": "azure monitor",
        "version": "1",
        "storageUri": "/subscriptions/32e58a75-e6e2-4539-93ae-27b1ee3bb81b/resourceGroups/AzFileShareQuotaManager/providers/Microsoft.Storage/storageAccounts/ququotamgr3cm5dzmnn2isvk"
      }
    }
  ],
  "outputs": {
    "queueStorageConnectionString": {
      "type": "string",
      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('QUstorageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('QUstorageAccountName')), '2021-06-01').keys[0].value)]"
    }
  }
}